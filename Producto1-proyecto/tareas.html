<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero - Back-end con Java</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="d-flex" id="wrapper">
        <div class="bg-light border-right" id="sidebar-wrapper">
            <div class="sidebar-heading">Menú</div>
            <div class="list-group list-group-flush">
                <a href="index.html" class="list-group-item list-group-item-action bg-light">Mis Proyectos</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Configuración</a>
                <a href="#" class="list-group-item list-group-item-action bg-light">Salir</a>
            </div>
        </div>

        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="menu-toggle">☰</button>
                    <a class="navbar-brand mx-auto" href="index.html">
                        <img src="assets/logo.png" alt="JSConnect TodoList">
                    </a>
                </div>
            </nav>

            <div class="container-fluid">
                <h1 class="mt-4">Tablero - Back-end con Java</h1>

                <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#newTaskModal">Añadir Tarea</button>

                <div class="row mt-4">
                    <div class="col-lg-4">
                        <h3>Por Hacer</h3>
                        <div id="porHacer" class="tareas-columna" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="col-lg-4">
                        <h3>En Proceso</h3>
                        <div id="enProceso" class="tareas-columna" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="col-lg-4">
                        <h3>Finalizado</h3>
                        <div id="finalizado" class="tareas-columna" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newTaskModalLabel">Nueva Tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="panelId" value="613b6c867ff9e3a1d0801234">
                    <div class="mb-3">
                        <label for="newTaskTitle" class="form-label">Título del Elemento</label>
                        <input type="text" class="form-control" id="newTaskTitle" placeholder="Introduce el título" required>
                    </div>
                    <div class="mb-3">
                        <label for="newTaskDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="newTaskDescription" rows="3" placeholder="Descripción" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="newTaskEstado" class="form-label">Estado</label>
                        <select class="form-control" id="newTaskEstado" required>
                            <option value="porHacer">Por Hacer</option>
                            <option value="enProceso">En Proceso</option>
                            <option value="finalizado">Finalizado</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveTaskButton">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = 'http://localhost:4000/graphql';
    
        const urlParams = new URLSearchParams(window.location.search);
        const panelId = urlParams.get('id');
    
        async function addTask(title, description, panelId) {
    const mutation = `
        mutation {
            createTask(title: "${title}", description: "${description}", panelId: "${panelId}") {
                id
                title
                description
                completed
                panelId
            }
        }
    `;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: mutation }),
        });

        const result = await response.json();
        if (response.ok) {
            return result.data.createTask;
        } else {
            console.error('GraphQL errors:', result.errors);
        }
    } catch (error) {
        console.error('Error creating task:', error);
    }
}

    
        async function displayTasks() {
            const porHacer = document.getElementById('porHacer');
            const enProceso = document.getElementById('enProceso');
            const finalizado = document.getElementById('finalizado');
    
            // Lógica para cargar las tareas del servidor y mostrarlas...
        }
    
        document.getElementById('saveTaskButton').addEventListener('click', async function () {
    const title = document.getElementById('newTaskTitle').value;
    const description = document.getElementById('newTaskDescription').value;
    const panelId = document.getElementById('panelId').value; // Asegúrate de que este ID sea válido

    const newTask = await addTask(title, description, panelId);

            if (newTask) {
                // Añadir la nueva tarea al DOM...
                const targetColumn = document.getElementById(estado);
                targetColumn.innerHTML += `
                    <div class="task" draggable="true" ondragstart="drag(event)" id="${newTask.id}">
                        <h5>${newTask.title}</h5>
                        <p>${newTask.description}</p>
                    </div>`;
            } else {
                alert('Error al guardar la tarea. Revisa la consola para más detalles.');
            }
    
            // Resetear formulario
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDescription').value = '';
            document.getElementById('newTaskEstado').value = 'porHacer';
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('newTaskModal'));
            modal.hide();
        });
    
        document.addEventListener('DOMContentLoaded', function () {
            displayTasks(); // Cargar tareas al iniciar
        });
    </script>
    

    <script src="js/main.js"></script>
</body>
</html>
